name: Triton Builder

on:
  schedule:
    - cron: "0 8 * * *"

  workflow_dispatch:
    inputs:
      run_single_version_test:
        description: '▶️ Run a test build for a single Python version?'
        type: boolean
        default: false
      python_test_version:
        description: '🐍 Python version for the test build (e.g., 3.12)'
        type: string
        default: '3.12'
      run_latest_release_build:
        description: '🚀 Build a full release from the LATEST Triton release tag?'
        type: boolean
        default: false

jobs:
  # ===================================================================
  # JOB 1: Regular Nightly Build (from main branch)
  # ===================================================================
  nightly-build:
    # Run on schedule, or when manually dispatched without other options selected
    if: >
      github.event_name == 'schedule' ||
      (github.event_name == 'workflow_dispatch' &&
       !github.event.inputs.run_single_version_test &&
       !github.event.inputs.run_latest_release_build)
    strategy:
      fail-fast: false
      matrix:
        config:
        - {runs_on: "['self-hosted', 'x64-docker']", arch: 'x86_64', timeout: 120}
        - {runs_on: "['self-hosted', 'aarch64-docker']", arch: 'aarch64', timeout: 720}
    uses: ./.github/workflows/reusable-build-triton.yml
    with:
      runner: ${{ matrix.config.runs_on }}
      arch: ${{ matrix.config.arch }}
      timeout: ${{ matrix.config.timeout }}
      checkout-ref: 'main'  # For nightly, we always use the main branch
      package-name: 'triton-nightly'
      cibw-build: 'cp3{10,11,12,13}-manylinux_${{ matrix.config.arch }}'
      cibw-skip: 'cp{35,36,37,38,39,13t}-*'
    secrets: inherit

  # ===================================================================
  # JOB 2: Single Python Version Test Build (Manually Triggered)
  # ===================================================================
  # This first job just prepares the python version string for the matrix in the next job
  prepare-test-build:
    if: github.event_name == 'workflow_dispatch' && github.event.inputs.run_single_version_test
    # This setup job runs on your runner. It just needs shell access.
    runs-on: ['self-hosted', 'x64-docker']
    outputs:
      matrix: ${{ steps.prepare-vars.outputs.matrix }}
    steps:
      - id: prepare-vars
        run: |
          py_ver_nodot=$(echo "${{ github.event.inputs.python_test_version }}" | tr -d '.')
          # Create a matrix for the next job
          MATRIX_JSON=$(cat <<EOF
          {
            "include": [
              {
                "config": {
                  "runs_on": "['self-hosted', 'x64-docker']", "arch": "x86_64", "timeout": 120
                },
                "cibw_build_spec": "cp${py_ver_nodot}-manylinux_x86_64"
              },
              {
                "config": {
                  "runs_on": "['self-hosted', 'aarch64-docker']", "arch": "aarch64", "timeout": 720
                },
                "cibw_build_spec": "cp${py_ver_nodot}-manylinux_aarch64"
              }
            ]
          }
          EOF
          )
          echo "matrix=${MATRIX_JSON}" >> $GITHUB_OUTPUT

  # This job executes the actual test build using the matrix from the previous job
  execute-test-build:
    needs: prepare-test-build
    strategy:
      fail-fast: false
      matrix: ${{ fromJson(needs.prepare-test-build.outputs.matrix) }}
    uses: ./.github/workflows/reusable-build-triton.yml
    with:
      runner: ${{ matrix.config.runs_on }}
      arch: ${{ matrix.config.arch }}
      timeout: ${{ matrix.config.timeout }}
      checkout-ref: 'main' # Test builds are also from the main branch
      package-name: 'triton-nightly'
      cibw-build: ${{ matrix.cibw_build_spec }}
    secrets: inherit

  # ===================================================================
  # JOB 3: Latest Release Tag Build (Manually Triggered)
  # ===================================================================
  # This job checks out the Triton repo just to find the latest tag name
  discover-latest-tag:
    if: github.event_name == 'workflow_dispatch' && github.event.inputs.run_latest_release_build
    # This discovery job runs on your runner. It must have git installed.
    runs-on: ['self-hosted', 'x64-docker']
    outputs:
      tag: ${{ steps.get-tag.outputs.tag }}
    steps:
      - name: Checkout Triton repo to find its tags
        uses: actions/checkout@v4
        with:
          repository: triton-lang/triton
          fetch-depth: 0 # Fetch all history/tags, not just the latest commit
      - name: Get latest tag name
        id: get-tag
        run: |
          # 'git describe' gets the most recent tag. '--abbrev=0' removes the commit hash suffix.
          latest_tag=$(git describe --tags --abbrev=0)
          echo "Discovered latest Triton tag: ${latest_tag}"
          echo "tag=${latest_tag}" >> $GITHUB_OUTPUT

  # This job executes the build using the tag discovered in the previous job
  execute-release-build:
    needs: discover-latest-tag
    if: needs.discover-latest-tag.outputs.tag != ''
    strategy:
      fail-fast: false
      matrix:
        config:
        - {runs_on: "['self-hosted', 'x64-docker']", arch: 'x86_64', timeout: 120}
        # - {runs_on: "['self-hosted', 'aarch64-docker']", arch: 'aarch64', timeout: 720}
    uses: ./.github/workflows/reusable-build-triton.yml
    with:
      runner: ${{ matrix.config.runs_on }}
      arch: ${{ matrix.config.arch }}
      timeout: ${{ matrix.config.timeout }}
      # Use the tag discovered from the previous job
      checkout-ref: ${{ needs.discover-latest-tag.outputs.tag }}
      package-name: 'triton' # This is a release build
      cibw-build: 'cp3*-manylinux_${{ matrix.config.arch }}'
      cibw-skip: 'cp{35,36,37,38,39}-*'
    secrets: inherit